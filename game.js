let questions = [
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://upload.wikimedia.org/wikipedia/commons/9/94/Air_Cennet_ve_Cehennem.png",
        "Doğru Cevap": "MERSİN"
    },
    {
        "Soru Metni": "which city does this photo belong to?",
        "Görsel URL": "http://assets.enuygun.com/media/lib/825x620/uploads/image/tuzgolu1-34357.webp",
        "Doğru Cevap": "KONYA"
    },
    {
        "Soru Metni": "which city does this photo belong to?",
        "Görsel URL": "http://assets.enuygun.com/media/lib/825x620/uploads/image/yedigoller-38939.webp",
        "Doğru Cevap": "BOLU"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://cevreonline.com/wp-content/uploads/2019/09/salda-golu.jpg",
        "Doğru Cevap": "BURDUR"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://imgscdn.stargazete.com/imgsdisk/2022/09/30/kapadokyada-peri-bacalari-534_2-41.jpg",
        "Doğru Cevap": "NEVŞEHİR"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "http://assets.enuygun.com/media/lib/825x620/uploads/image/kaputas-plaji-36591.webp",
        "Doğru Cevap": "ANTALYA"
    },
    {
        "Soru Metni": "which city does this photo belong to?",
        "Görsel URL": "http://assets.enuygun.com/media/lib/825x620/uploads/image/balikligol-16360.webp",
        "Doğru Cevap": "ŞANLIURFA"
    },
    {
        "Soru Metni": "which city does this photo belong to?",
        "Görsel URL": "http://assets.enuygun.com/media/lib/825x620/uploads/image/uludag-25487.webp",
        "Doğru Cevap": "BURSA"
    },
    {
        "Soru Metni": "which city does this photo belong to?",
        "Görsel URL": "https://www.kulturportali.gov.tr/contents/images/THK-ORHAN%20%c3%96ZG%c3%9cLBA%c5%9e-D%c4%b0YARBAKIR.jpg?format=jpg&quality=50&width=1200",
        "Doğru Cevap": "DİYARBAKIR"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/de/Pamukkale_30.jpg/1920px-Pamukkale_30.jpg",
        "Doğru Cevap": "DENİZLİ"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://www.kulturportali.gov.tr/contents/images/Yukar%c4%b1%20D%c3%bcden_Servet%20Uygun%20logolu.jpg",
        "Doğru Cevap": "ANTALYA"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://upload.wikimedia.org/wikipedia/commons/thumb/f/fc/EG%C4%B0RD%C4%B0R_G%C3%96L%C3%9C.jpg/1280px-EG%C4%B0RD%C4%B0R_G%C3%96L%C3%9C.jpg",
        "Doğru Cevap": "ISPARTA"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://upload.wikimedia.org/wikipedia/commons/9/90/Damlata%C5%9F_Cave.jpg",
        "Doğru Cevap": "ANTALYA"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://visitturkey.in/wp-content/uploads/2024/07/oludeniz-fethiye.webp",
        "Doğru Cevap": "MUĞLA"
    },
    {
        "Soru Metni": "which city does this photo belong to?",
        "Görsel URL": "http://assets.enuygun.com/media/lib/825x620/uploads/image/igneada-34157.webp",
        "Doğru Cevap": "KIRKLARELİ"
    },
    {
        "Soru Metni": "which city does this photo belong to?",
        "Görsel URL": "https://www.arkeogezgin.com/wp-content/uploads/2017/11/IMG_0706.jpg",
        "Doğru Cevap": "DENİZLİ"
    },
    {
        "Soru Metni": "which city does this photo belong to?",
        "Görsel URL": "https://www.kapadokyadayim.com/wp-content/uploads/2017/03/ihlara-vadisi.jpg",
        "Doğru Cevap": "AKSARAY"
    },
    {
        "Soru Metni": "which city does this photo belong to?",
        "Görsel URL": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d5/G%C3%B6bekli_Tepe%2C_Urfa.jpg/1280px-G%C3%B6bekli_Tepe%2C_Urfa.jpg",
        "Doğru Cevap": "ŞANLIURFA"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/%C3%87%C4%B1ld%C4%B1r_G%C3%B6l%C3%BCnde_Atl%C4%B1_K%C4%B1zak.jpg/1280px-%C3%87%C4%B1ld%C4%B1r_G%C3%B6l%C3%BCnde_Atl%C4%B1_K%C4%B1zak.jpg",
        "Doğru Cevap": "KARS"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://www.gotatil.com/blog/wp-content/webp-express/webp-images/doc-root/blog/wp-content/uploads/2022/07/saklikent-kanyonu-768x783.jpg.webp",
        "Doğru Cevap": "MUĞLA"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://www.hisglobal.com.tr/assets/images/uploads/1598444401.jpg",
        "Doğru Cevap": "ADIYAMAN"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "http://assets.enuygun.com/media/lib/825x620/uploads/image/agri-dagi-35771.webp",
        "Doğru Cevap": "AĞRI"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "http://assets.enuygun.com/media/lib/825x620/uploads/image/akdamar-adasi-na-nasil-gidilir-52107.webp",
        "Doğru Cevap": "VAN"
    },
    {
        "Soru Metni": "which city does this photo belong to?",
        "Görsel URL": "http://assets.enuygun.com/media/lib/825x620/uploads/image/erciyes-dagi-813.webp",
        "Doğru Cevap": "KAYSERİ"
    },
    {
        "Soru Metni": "In which city is the natural beauty in the photo?",
        "Görsel URL": "https://cdng.jollytur.com/files/packagephoto/packagephotos/4d402217-ab7f-4d2a-93ad-6f31d54c1325-1024.png",
        "Doğru Cevap": "RİZE"
    }

];
let currentQuestionIndex = 0;
let score = 0;
let timer;
// MAP SETTINGS


const map = L.map('map').setView([39.92077, 32.85411], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 10,
}).addTo(map);




map.on('click', async (e) => {
    const { lat, lng } = e.latlng;
    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
    const data = await response.json();
    const selectedCity = data.address?.province?.toUpperCase();

    if (selectedCity) {
        const normalizedCity = normalizeText(selectedCity);
        const userConfirmed = confirm(`Selected city: ${selectedCity}. Are you sure?`);
        if (userConfirmed) {
            checkAnswer(normalizedCity);
        }
    } else {
        alert("City information could not be loaded. Please choose a different location.");
    }
});


function showMainMenu() {
    document.getElementById('main-menu').classList.remove('hidden');
    document.getElementById('settings').classList.add('hidden');
    document.getElementById('game').classList.add('hidden');
    document.getElementById('top-scores').classList.add('hidden');
}


function showSettings() {
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('settings').classList.remove('hidden');
}

function saveSettings() {
    const timeLimit = parseInt(document.getElementById('time-limit').value, 10);
    const questionCount = parseInt(document.getElementById('question-count').value, 10);
    localStorage.setItem('settings', JSON.stringify({ timeLimit, questionCount }));
    alert('Settings Saved Successfully!');
}



//Excel File Settings

async function excelToJson(file) {
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    return XLSX.utils.sheet_to_json(sheet);
}

document.getElementById('file-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    questions = [];
    questions = await excelToJson(file);

    if (questions.length > 0) {
        shuffleArray(questions);
        const settings = JSON.parse(localStorage.getItem('settings')) || {};
        const questionLimit = settings.questionCount || questions.length;
        questions = questions.slice(0, questionLimit);
        alert(`Questions Loaded and ${questions.length} Question Selected. You can start the game.`);
        currentQuestionIndex = 0;
        console.log(questions);
    } else {
        alert("Questions in Excel file could not be read.");
    }


});

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}


//GAME SETTINGS
function startGame() {
    setTimeout(() => {
        document.body.style.transition = "transform 0.3s ease";
        document.body.style.transform = "scale(0.99)";

        setTimeout(() => {
            document.body.style.transform = "scale(1)";
            setTimeout(() => {
                document.body.style.transition = "";
                map.invalidateSize();
            }, 300);
        }, 300);
    }, 500);
    const video = document.getElementById('background-video');
    video.style.display = 'none';
    resetGameState();
    shuffleArray(questions);
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('game').classList.remove('hidden');
    startTimer();
    showQuestion(0);
}

function endGame() {
    clearInterval(timer);
    const playerName = prompt('Game Over! Enter your Name:');
    const scores = JSON.parse(localStorage.getItem('topScores') || '[]');
    scores.push({ name: playerName, score });
    localStorage.setItem('topScores', JSON.stringify(scores));
    alert(`
Your score has been saved: ${score}`);
    showMainMenu();
}

function resetGameState() {
    currentQuestionIndex = 0;
    score = 0;
    clearInterval(timer);
    document.getElementById('score').textContent = `Puan: ${score}`;
    const settings = JSON.parse(localStorage.getItem('settings')) || {};
    const questionLimit = settings.questionCount || questions.length;
    shuffleArray(questions);
    questions = questions.slice(0, questionLimit);
}

function startTimer() {
    const settings = JSON.parse(localStorage.getItem('settings'));
    let timeLeft = settings?.timeLimit || 60;

    document.getElementById('timer').textContent = `Süre: ${timeLeft}`;
    timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = `Süre: ${timeLeft}`;
        if (timeLeft <= 0) {
            clearInterval(timer);
            endGame();
        }
    }, 1000);
}

function showQuestion(index) {
    if (index < questions.length) {
        const question = questions[index];
        document.getElementById('question-text').textContent = question['Soru Metni'];
        document.getElementById('question-image').src = question['Görsel URL'];
    } else {
        endGame();
    }
}


async function checkAnswer(selectedCity) {
    const correctCity = questions[currentQuestionIndex]['Doğru Cevap'];
    const normalizedSelectedCity = normalizeText(selectedCity);
    const normalizedCorrectCity = normalizeText(correctCity);

    if (normalizedSelectedCity === normalizedCorrectCity) {
        alert("Correct! You earned points.");
        score += 10;
    } else {
        alert(`Wrong! Correct Answer: ${correctCity}`);
    }

    document.getElementById('score').textContent = `Point: ${score}`;
    currentQuestionIndex++;

    if (currentQuestionIndex < questions.length) {
        showQuestion(currentQuestionIndex);
    } else {
        endGame();
    }
}



function normalizeText(text) {
    const charMap = {
        'Ç': 'C', 'Ğ': 'G', 'İ': 'I', 'Ö': 'O', 'Ş': 'S', 'Ü': 'U',
        'ç': 'c', 'ğ': 'g', 'ı': 'i', 'ö': 'o', 'ş': 's', 'ü': 'u',
    };

    return text
        .toUpperCase()
        .replace(/[ÇĞİÖŞÜçğıöşü]/g, char => charMap[char] || char);
}

function showTopScores() {
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('top-scores').classList.remove('hidden');

    const scoreList = document.getElementById('score-list');
    scoreList.innerHTML = '';

    const scores = JSON.parse(localStorage.getItem('topScores') || '[]');
    scores.sort((a, b) => b.score - a.score).slice(0, 10).forEach((entry, index) => {
        const li = document.createElement('li');
        li.textContent = `${index + 1}. ${entry.name} - ${entry.score}`;
        scoreList.appendChild(li);
    });
}
